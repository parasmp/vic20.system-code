* Comments by Willi Kusche
;.PAGE 'VIC OPERATING SYSTEM PART 2  "SVO2"  7/13/82'
	INCLUDE	VMMAP.h
AA000	EQU	$A000
;
;	ENTRY POINTS
;
*	.ENT	AF3FF
*	.ENT	AF422
*	.ENT	AF8B9
*	.ENT	UPDCLK
*	.ENT	VAF39E
;
;	BASIC REFERENCES
;
BCSVEC	EQU	$C000	; BASIC COLD START
BWSVEC	EQU	$C002	; BASIC WARM START
;
;	OP SYS PART 1 REFERENCES
;
KEYBIP	EQU	$E5CF
VAE4A0	EQU	$E4A0
VAE4A9	EQU	$E4A9
VAE4B2	EQU	$E4B2
VAE4BC	EQU	$E4BC
VAE4C1	EQU	$E4C1
VAE4CF	EQU	$E4CF
RDIOAD	EQU	$E500
RDSPRM	EQU	$E505
PLOT	EQU	$E50A
AE1E1	EQU	$E518
VAE5C3	EQU	$E5C3
INTSVC	EQU	$EABF
SCANKB	EQU	$EB1E
SCKBIP	EQU	$E64F
SCROP	EQU	$E742
;.PAGE 'IEEE LOGIC'
	ORG	$EE14
AF0B6	ORA	#$40
	DB	$2C
AF0BA	ORA	#$20
	JSR	VAF160
AF0BC	PHA
	BIT	A021D
	BPL	VOSGI
	SEC
	ROR	A026C
	JSR	VAEE49
	LSR	A021D
	LSR	A026C
VOSGI	PLA
	STA	A0222
	JSR	VAE4A0
	CMP	#$3F
	BNE	VOSGJ
	JSR	VAEF84
VOSGJ	LDA	A911F
	ORA	#$80
	STA	A911F
AF0F1	JSR	VAEF8D
	JSR	VAE4A0
	JSR	VAEF96
VAEE49	SEI
	JSR	VAE4A0
	JSR	VAE4B2
	LSR	A
	BCS	VAEEB4
	JSR	VAEF84
	BIT	A026C
	BPL	VOSGL
VOSGM	JSR	VAE4B2
	LSR	A
	BCC	VOSGM
VOSGN	JSR	VAE4B2
	LSR	A
	BCS	VOSGN
VOSGL	JSR	VAE4B2
	LSR	A
	BCC	VOSGL
	JSR	VAEF8D
	LDA	#$08
	STA	A026F
VOSGP	LDA	A911F
	CMP	A911F
	BNE	VOSGP
	LSR	A
	LSR	A
	BCC	VAEEB7
	ROR	A0222
	BCS	VOSGR
	JSR	VAE4A9
	BNE	VOSGS
VOSGR	JSR	VAE4A0
VOSGS	JSR	VAEF84
	NOP
	NOP
	NOP
	NOP
	LDA	A912C
	AND	#$DF
	ORA	#$02
	STA	A912C
	DEC	A026F
	BNE	VOSGP
	LDA	#$04
	STA	A9129
VOSGV	LDA	A912D
	AND	#$20
	BNE	VAEEB7
	JSR	VAE4B2
	LSR	A
	BCS	VOSGV
	CLI
	RTS
;
;
;
VAEEB4	LDA	#$80
	DB	$2C
VAEEB7	LDA	#$03
VAEEB9	JSR	AFBE5
	CLI
	CLC
	BCC	VOSGW
;
;
;
AF12C	STA	A0222
	JSR	AF0F1
AF132	LDA	A911F
	AND	#$7F
	STA	A911F
	RTS
;
;
;
AF15B	STA	A0222
	JSR	AF0F1
AF161	SEI
	JSR	VAE4A9
	JSR	AF132
	JSR	VAEF84
VOSGX	JSR	VAE4B2
	BCS	VOSGX
	CLI
	RTS
;
;
;
AF167	BIT	A021D
	BMI	ZD
	SEC
	ROR	A021D
	BNE	ZE
ZD	PHA
	JSR	VAEE49
	PLA
ZE	STA	A0222
	CLC
	RTS
;
;
;
VAEEF6	JSR	VAEF8D
	LDA	A911F
	ORA	#$80
	STA	A911F
AF17A	LDA	#$5F
	DB	$2C
AF17E	LDA	#$3F
	JSR	AF0BC
VOSGW	JSR	AF132
VAEF0C	TXA
	LDX	#$0B
VOSHA	DEX
	BNE	VOSHA
	TAX
	JSR	VAEF84
	JMP	VAE4A0
;
;
;
AF187	SEI
	LDA	#$00
	STA	A026F
	JSR	VAEF84
VOSHB	JSR	VAE4B2
	BCC	VOSHB
	JSR	VAE4A0
VOSHG	LDA	#$01
	STA	A9129
VOSHD	LDA	A912D
	AND	#$20
	BNE	VOSHC
	JSR	VAE4B2
	BCS	VOSHD
	BCC	VOSHE
VOSHC	LDA	A026F
	BEQ	VOSHF
	LDA	#$02
	JMP	VAEEB9
VOSHF	JSR	VAE4A9
	JSR	VAEF0C
	LDA	#$40
	JSR	AFBE5
	INC	A026F
	BNE	VOSHG
VOSHE	LDA	#$08
	STA	A026F
VOSHH	LDA	A911F
	CMP	A911F
	BNE	VOSHH
	LSR	A
	BCC	VOSHH
	LSR	A
	ROR	A026D
VOSHJ	LDA	A911F
	CMP	A911F
	BNE	VOSHJ
	LSR	A
	BCS	VOSHJ
	DEC	A026F
	BNE	VOSHH
	JSR	VAE4A9
	LDA	STATUS
	BEQ	VOSHM
	JSR	VAEF0C
VOSHM	LDA	A026D
	CLI
	CLC
	RTS
;
;
;
VAEF84	LDA	A912C
	AND	#$FD
	STA	A912C
	RTS
;
;
;
VAEF8D	LDA	A912C
	ORA	#$02
	STA	A912C
	RTS
;
;
;
VAEF96	LDA	#$04
	STA	A9129
VOSHN	LDA	A912D
	AND	#$20
	BEQ	VOSHN
	RTS
;
;
;
VAEFA3	LDA	ZEB
	BEQ	VOSHO
	BMI	VOSHP
	LSR	VZB6
	LDX	#$00
	BCC	VOSHQ
	DEX
VOSHQ	TXA
	EOR	ZFC
	STA	ZFC
	DEC	ZEB
	BEQ	VOSHR
VOSHW	TXA
	AND	#$20
	STA	VZB5
	RTS
VOSHR	LDA	#$20
	BIT	V0294
	BEQ	VOSHS
	BMI	VOSHT
	BVS	VOSHU
	LDA	ZFC
	BNE	VOSHV
VOSHY	DEX
VOSHV	DEC	ZEB
	LDA	V0293
	BPL	VOSHW
	DEC	ZEB
	BNE	VOSHW
VOSHS	INC	ZEB
	BNE	VOSHY
VOSHU	LDA	ZFC
	BEQ	VOSHV
	BNE	VOSHY
VOSHT	BVS	VOSHV
	BVC	VOSHY
VOSHP	INC	ZEB
	LDX	#$FF
	BNE	VOSHW
VOSHO	LDA	V0294
	LSR	A
	BCC	VOSIE
	BIT	A9120
	BPL	VAF016
	BVC	VAF019
VOSIE	LDA	#$00
	STA	ZFC
	STA	VZB5
	LDX	V0298
	STX	ZEB
	LDY	V029D
	CPY	V029E
	BEQ	VOSIH
	LDA	(VZF9),Y
	STA	VZB6
	INC	V029D
	RTS
VAF016	LDA	#$40
	DB	$2C
VAF019	LDA	#$10
	ORA	V0297
	STA	V0297
VOSIH	LDA	#$40
	STA	A911E
	RTS
;
;
;
VAF027	LDX	#$09
	LDA	#$20
	BIT	V0293
	BEQ	VOSII
	DEX
VOSII	BVC	VOSIJ
	DEX
	DEX
VOSIJ	RTS
;
;
;
VAF036	LDX	A0275
	BNE	VOSIK
	DEC	A0274
	BEQ	VOSIL
	BMI	VOSIM
	LDA	A0273
	EOR	A0279
	STA	A0279
	LSR	A0273
	ROR	A0278
VOSIO	RTS
VOSIT	DEC	A0274
VOSIM	LDA	A0273
	BEQ	VOSIN
	LDA	V0293
	ASL	A
	LDA	#$01
	ADC	A0274
	BNE	VOSIO
VOSIP	LDA	#$90
	STA	A911E
	STA	A0275
	LDA	#$20
	STA	A911E
	RTS
VOSIK	LDA	A0273
	BNE	VOSIP
	STA	A0275
	RTS
VOSIL	LDY	V029B
	INY
	CPY	V029C
	BEQ	VOSIQ
	STY	V029B
	DEY
	LDA	A0278
	LDX	V0298
VOSIS	CPX	#$09
	BEQ	VOSIR
	LSR	A
	INX
	BNE	VOSIS
VOSIR	STA	(VZF7),Y
	LDA	#$20
	BIT	V0294
	BEQ	VOSIT
	BMI	VOSIO
	LDA	A0273
	EOR	A0279
	BEQ	VOSIV
	BVS	VOSIO
	DB	$2C
VOSIV	BVC	VOSIO
	LDA	#$01
	DB	$2C
VOSIQ	LDA	#$04
	DB	$2C
VOSIY	LDA	#$80
	DB	$2C
VOSIX	LDA	#$02
	ORA	V0297
	STA	V0297
	JMP	VOSIP
VOSIN	LDA	A0278
	BNE	VOSIX
	BEQ	VOSIY
;
;
;
JE9	JMP	VAF796
;.PAGE 'DEVICE 2 SUPPORT'
;
;	SET OUTPUT DEVICE
;
VAF0BC	STA	OUTDVC
	LDA	V0294
	LSR	A
	BCC	VOSIZ
	LDA	#$02
	BIT	A9110
	BPL	VOSJA
	BNE	VOSIZ
VOSJC	LDA	A911E
	AND	#$30
	BNE	VOSJC
VOSJD	BIT	A9110
	BVS	VOSJD
	LDA	A9110
	ORA	#$02
	STA	A9110
VOSJF	BIT	A9110
	BVS	VOSIZ
	BMI	VOSJF
VOSJA	JSR	VAF016
VOSIZ	CLC
	RTS
;
;	CHARACTER OUTPUT
;
VAF0ED	LDY	V029E
	INY
	CPY	V029D
	BEQ	VAF0ED
	STY	V029E
	DEY
	STA	(VZF9),Y
	BIT	A911E
	BVC	VOSJH
	RTS
VOSJH	LDA	V0299
	STA	A9114
	LDA	V0299+1
	STA	A9115
	LDA	#$C0
	STA	A911E
	JMP	VOSHO
;
;	SET INPUT DEVICE
;
VAF116	STA	INDVC
	LDA	V0294
	LSR	A
	BCC	VOSJI
	AND	#$08
	BEQ	VOSJI
	LDA	#$02
	BIT	A9110
	BPL	VOSJA
	BEQ	VOSJL
VOSJM	BIT	A911E
	BVS	VOSJM
	LDA	A9110
	AND	#$FD
	STA	A9110
VOSJN	LDA	A9110
	AND	#$04
	BEQ	VOSJN
VOSJO	LDA	#$90
	STA	A911E
VOSJL	CLC
	RTS
VOSJI	LDA	A911E
	AND	#$30
	BEQ	VOSJO
	CLC
	RTS
;
;	CHARACTER INPUT
;
VAF14F	LDY	V029C
	CPY	V029B
	BEQ	VOSJP
	LDA	(VZF7),Y
	INC	V029C
	RTS
VOSJP	LDA	#$00
	RTS
;
;
;
VAF160	PHA
VAF161	LDA	A911E
	BEQ	VOSJQ
VOSJR	LDA	A911E
	AND	#$60
	BNE	VOSJR
	LDA	#$10
	STA	A911E
VOSJQ	PLA
	RTS
;.PAGE 'Message display'
;
;	Constants
;
ERMSGS
ERRORK	DB	CR
	ASC	'I/O ERROR '
	DB	'#+%10000000
;
SERCHK	DB	CR
	ASC	'SEARCHING'
	DB	SPACE+%10000000
;
FORK	ASC	'FOR'
	DB	SPACE+%10000000
;
PPLAYK	DB	CR
	ASC	'PRESS PLAY ON TAP'
	DB	'E+%10000000
;
PRECK	ASC	'PRESS RECORD & PLAY ON TAP'
	DB	'E+%10000000
;
LOADK	DB	CR
	ASC	'LOADIN'
	DB	'G+%10000000
;
SAVEK	DB	CR
	ASC	'SAVING'
	DB	SPACE+%10000000
;
VERK	DB	CR
	ASC	'VERIFYIN'
	DB	'G+%10000000
;
FOUNDK	DB	CR
	ASC	'FOUND'
	DB	SPACE+%10000000
;
OKK	DB	CR
	ASC	'OK'
	DB	CR+%10000000
;
;
;
VAF1E2	BIT	DRCTSW
	BPL	VOSKC
;
;	Display error message
;
DSPERR	LDA	ERMSGS,Y
	PHP
	AND	#$7F
	JSR	OUTCH
	INY
	PLP
	BPL	DSPERR
VOSKC	CLC
	RTS
;.PAGE 'Character input'
;
;	Get a character
;
GCH	LDA	INDVC
	BNE	VGA
;
;	TEST KEY PUSH COUNTER
;
	LDA	KEYCNT
	BEQ	RTSAE
	SEI
	JMP	KEYBIP
;
;
;
VGA	CMP	#$02
	BNE	YJ
VAF205	STY	A0261
	JSR	VAF14F
	LDY	A0261
	CLC
	RTS
;
;	TEST FOR KEYBOARD INPUT DEVICE
;
ICH	LDA	INDVC
	BNE	YJ
	LDA	SCRNDX
	STA	A0221
	LDA	SLINNO
	STA	A0220
	JMP	SCKBIP
YJ	CMP	#SCREEN
	BNE	YK
	STA	SCKBFL
	LDA	SWRPFL
	STA	SIPLIM
	JMP	SCKBIP
YK	BCS	YP
	CMP	#$02
	BEQ	VGB
	STX	A0261
	JSR	NRF215
	BCS	VGE
	PHA
	JSR	NRF215
	BCS	VGD
	BNE	YN
	LDA	#$40
	JSR	AFBE5
YN	DEC	A0270
	LDX	A0261
	PLA
	RTS
VGD	TAX
	PLA
	TXA
VGE	LDX	A0261
	RTS
;
;
;
NRF215	JSR	AF82D
	BNE	NRYN
	JSR	AF87F
	BCS	VGF
	LDA	#$00
	STA	A0270
	BEQ	NRF215
NRYN	LDA	(ZF3),Y
	CLC
	RTS
;
;
;
YP	LDA	STATUS
	BEQ	YR
	LDA	#$0D
RTSAE	CLC
VGF	RTS
YR	JMP	AF187
;
;
;
VGB	JSR	VAF205
	BCS	VGC
	CMP	#$00
	BEQ	VGB
	CLC
VGC	RTS
;.PAGE 'CHARACTER OUTPUT'
OCH	PHA
	LDA	OUTDVC
	CMP	#SCREEN
	BNE	PEH
	PLA
	JMP	SCROP
PEH	BCC	PEJ
	PLA
	JMP	AF167
PEJ	CMP	#$02
	BEQ	VGG
	PLA
AF248	STA	ZE9
	PHA
	TXA
	PHA
	TYA
	PHA
	JSR	AF82D
	BNE	PEP
	JSR	AF8B9
	BCS	RESTRG
	LDA	#$02
	LDY	#0
	STA	(ZF3),Y
	INY
	STY	A0270
PEP	LDA	ZE9
	STA	(ZF3),Y
	CLC
RESTRG	PLA
	TAY
	PLA
	TAX
	PLA
	BCC	VGH
	LDA	#0
VGH	RTS
;
;
;
VGG	PLA
	STX	A0261
	STY	ZE9
	JSR	VAF0ED
	LDX	A0261
	LDY	ZE9
	CLC
	RTS
;.PAGE 'SET INPUT DEVICE'
;
;
;
SIDV	JSR	VAF3CF
	BEQ	PDM
	JMP	VAF784
PDM	JSR	AF2B8
	LDA	DVCNUM
	BEQ	PDN
	CMP	#SCREEN
	BEQ	PDN
	BCS	PDP
	CMP	#$02
	BNE	VOSLE
	JMP	VAF116
VOSLE	LDX	IOOPT
	CPX	#$60
	BEQ	PDN
	JMP	VAF78D
PDN	STA	INDVC
	CLC
	RTS
;
;	IEEE DEVICE LOGIC
;
PDP	TAX
	JSR	AF0B6
	LDA	IOOPT
	BPL	PDQ
	JSR	AF161
	JMP	PDR
PDQ	JSR	AF15B
PDR	TXA
	BIT	STATUS
	BPL	PDN
	JMP	VAF78A
;.PAGE 'SET OUTPUT DEVICE'
;
;	VALIDATE FILE NUMBER
;
SODV	JSR	VAF3CF
	BEQ	VOSLI
	JMP	VAF784
VOSLI	JSR	AF2B8
	LDA	DVCNUM
	BNE	NRDS
VOSLN	JMP	VAF790
NRDS	CMP	#SCREEN
	BEQ	PDT
	BCS	PDU
	CMP	#$02
	BNE	VOSLM
	JMP	VAF0BC
VOSLM	LDX	IOOPT
	CPX	#$60
	BEQ	VOSLN
PDT	STA	OUTDVC
	CLC
	RTS
;
;	IEEE DEVICE LOGIC
;
PDU	TAX
	JSR	AF0BA
	LDA	IOOPT
	BPL	PDV
	JSR	AF132
	BNE	PDL
PDV	JSR	AF12C
PDL	TXA
	BIT	STATUS
	BPL	PDT
	JMP	VAF78A
;.PAGE 'CLOSE'
CLOSE	JSR	AF2AB
	BEQ	VOSLR
	CLC
	RTS
VOSLR	JSR	AF2B8
	TXA
	PHA
	LDA	DVCNUM
	BEQ	PET
	CMP	#SCREEN
	BEQ	PET
	BCS	PES
	CMP	#$02
	BNE	VOSLV
	PLA
	JSR	VAF3B2
	LDA	#$7D
	STA	A911E
	LDA	#$06
	STA	A9110
	LDA	#$EE
	STA	A911C
	JSR	VAFE75
	LDA	VZF7+1
	BEQ	VOSLW
	INY
VOSLW	LDA	VZF9+1
	BEQ	VOSLX
	INY
VOSLX	LDA	#$00
	STA	VZF7+1
	STA	VZF9+1
	JMP	VOSNK
VOSLV	LDA	IOOPT
	AND	#$0F
	BEQ	PET
	JSR	AF667
	LDA	#$00
	JSR	AF248
	JMP	VAE4CF
VAF39E	BCS	VOSLZ
	LDA	IOOPT
	CMP	#$62
	BNE	PET
	LDA	#5
	JSR	AF5ED
	JMP	PET
PES	JSR	AF6E6
PET	PLA
VAF3B2	TAX
	DEC	A0262
	CPX	A0262
	BEQ	PEU
	LDY	A0262
	LDA	FINOAR,Y
	STA	FINOAR,X
	LDA	DVCNAR,Y
	STA	DVCNAR,X
	LDA	OPTAR,Y
	STA	OPTAR,X
PEU	CLC
VOSLZ	RTS
;.PAGE 'SUBROUTINES'
;
;
;
VAF3CF	LDA	#0
	STA	STATUS
	TXA
AF2AB	LDX	A0262
ZQ	DEX
	BMI	ZR
	CMP	FINOAR,X
	BNE	ZQ
	RTS
;
;
;
AF2B8	LDA	FINOAR,X
	STA	FILNUM
	LDA	DVCNAR,X
	STA	DVCNUM
	LDA	OPTAR,X
	STA	IOOPT
ZR	RTS
;.PAGE 'DEVICE RESTORE'
;
;	HALT I/O
;
NRF26E	LDA	#0
	STA	A0262
;
;	RESET I/O
;
AF27D	LDX	#SCREEN
	CPX	OUTDVC
	BCS	ZN
;
;	IEEE LOGIC
;
	JSR	AF17E
ZN	CPX	INDVC
	BCS	AF299
;
;	IEEE LOGIC
;
	JSR	VAEEF6
AF299	STX	OUTDVC
	LDA	#KEYBD
	STA	INDVC
	RTS
;.PAGE 'OPEN'
OPEN	LDX	FILNUM
	BNE	VOSMG
	JMP	VAF78D
VOSMG	JSR	VAF3CF
	BNE	VOSMH
	JMP	VAF781
VOSMH	LDX	A0262
	CPX	#10
	BCC	VOSMI
	JMP	VAF77E
VOSMI	INC	A0262
	LDA	FILNUM
	STA	FINOAR,X
	LDA	IOOPT
	ORA	#$60
	STA	IOOPT
	STA	OPTAR,X
	LDA	DVCNUM
	STA	DVCNAR,X
	BEQ	RTSAB
	CMP	#SCREEN
	BEQ	RTSAB
	BCC	VOSML
	JSR	AF462
	BCC	RTSAB
VOSML	CMP	#$02
	BNE	VOSMN
	JMP	VAF4C7
VOSMN	JSR	AF667
	BCS	PEM
	JMP	VAF796
PEM	LDA	IOOPT
	AND	#$0F
	BNE	AF592
	JSR	AF83B
	BCS	VOSMQ
	JSR	AF3FF
	LDA	FNSIZE
	BEQ	AF58B
	JSR	AF495
	BCC	PDA
	BEQ	VOSMQ
VOSMW	JMP	VAF787
;
;
;
AF58B	JSR	AF5AE
	BEQ	VOSMQ
	BCC	PDA
	BCS	VOSMW
AF592	JSR	AF871
	BCS	VOSMQ
	LDA	#$04
	JSR	AF5ED
PDA	LDA	#191
	LDY	IOOPT
	CPY	#$60
	BEQ	PDB
	LDY	#0
	LDA	#$02
	STA	(ZF3),Y
	TYA
PDB	STA	A0270
RTSAB	CLC
VOSMQ	RTS
;.PAGE 'SUBROUTINES'
;
;
;
AF462	LDA	IOOPT
	BMI	RTSX
	LDY	FNSIZE
	BEQ	RTSX
	LDA	DVCNUM
	JSR	AF0BA
	LDA	IOOPT
	ORA	#$F0
	JSR	AF12C
	LDA	STATUS
	BPL	PAT
	PLA
	PLA
	JMP	VAF78A
PAT	LDA	FNSIZE
	BEQ	PAV
	LDY	#$00
VOSND	LDA	(FNADDR),Y
	JSR	AF167
	INY
	CPY	FNSIZE
	BNE	VOSND
PAV	JSR	AF17E
RTSX	CLC
	RTS
;
;
;
VAF4C7	LDA	#$06
	STA	A9112
	STA	A9110
	LDA	#$EE
	STA	A911C
	LDY	#$00
	STY	V0297
VOSNF	CPY	FNSIZE
	BEQ	VOSNE
	LDA	(FNADDR),Y
	STA	V0293,Y
	INY
	CPY	#$04
	BNE	VOSNF
VOSNE	JSR	VAF027
	STX	V0298
	LDA	V0293
	AND	#$0F
	BNE	VOSNG
VOSNG	ASL	A
	TAX
	LDA	VAFF5C-2,X
	ASL	A
	TAY
	LDA	VAFF5C-1,X
	ROL	A
	PHA
	TYA
	ADC	#$C8
	STA	V0299
	PLA
	ADC	#$00
	STA	V0299+1
	LDA	V0294
	LSR	A
	BCC	VOSNH
	LDA	A9120
	ASL	A
	BCS	VOSNH
	JMP	VAF016
VOSNH	LDA	V029B
	STA	V029C
	LDA	V029E
	STA	V029D
	JSR	VAFE75
	LDA	VZF7+1
	BNE	VOSNJ
	DEY
	STY	VZF7+1
	STX	VZF7
VOSNJ	LDA	VZF9+1
	BNE	VOSNK
	DEY
	STY	VZF9+1
	STX	VZF9
VOSNK	SEC
	LDA	#$F0
	JMP	VAFE7B
;.PAGE 'LOAD PROGRAM FILE LOGIC'
;
;
;
LOAD	STX	VZC3
	STY	VZC3+1
	JMP	(LODVEC)
;
;
;
DOLOAD	STA	OSLVSW
	LDA	#$00
	STA	STATUS
	LDA	DVCNUM
	BNE	PAC
PAD	JMP	VAF796
PAC	CMP	#SCREEN
	BEQ	PAD
	BCC	PAG
	LDY	FNSIZE
	BNE	NRAD
	JMP	VAF793
NRAD	JSR	VAE4BC
	LDA	#$60
	STA	IOOPT
	JSR	AF462
	LDA	DVCNUM
	JSR	AF0B6
	LDA	IOOPT
	JSR	AF15B
	JSR	AF187
	STA	SAVEND
	LDA	STATUS
	LSR	A
	LSR	A
	BCS	VOSNP
	JSR	AF187
	STA	SAVEND+1
	JSR	VAE4C1
PAN	LDA	#$FD
	AND	STATUS
	STA	STATUS
	JSR	CKSTOP
	BNE	VOSNQ
	JMP	VAF6CB
VOSNQ	JSR	AF187
	TAX
	LDA	STATUS
	LSR	A
	LSR	A
	BCS	PAN
	TXA
	LDY	OSLVSW
	BEQ	VOSNS
	LDY	#$00
	CMP	(SAVEND),Y
	BEQ	VOSNT
	LDA	#$10
	JSR	AFBE5
	DB	$2C
VOSNS	STA	(SAVEND),Y
VOSNT	INC	SAVEND
	BNE	VOSNU
	INC	SAVEND+1
VOSNU	BIT	STATUS
	BVC	PAN
	JSR	VAEEF6
	JSR	AF6E6
	BCC	VOSNW
VOSNP	JMP	VAF787
PAG	CMP	#$02
	BNE	VOSNX
	JMP	JE9
VOSNX	JSR	AF667
	BCS	VOSNY
	JMP	VAF796
VOSNY	JSR	AF83B
	BCS	VOSNZ
	JSR	AF3FF
PAL	LDA	FNSIZE
	BEQ	PAH
	JSR	AF495
	BCC	VOSOB
	BEQ	VOSNZ
	BCS	VOSNP
PAH	JSR	AF5AE
	BEQ	VOSNZ
	BCS	VOSNP
VOSOB	LDA	STATUS
	AND	#$10
	SEC
	BNE	VOSNZ
	CPX	#$01
	BEQ	VOSOH
	CPX	#$03
	BNE	PAL
VOSOK	LDY	#1
	LDA	(ZF3),Y
	STA	VZC3
	INY
	LDA	(ZF3),Y
	STA	VZC3+1
	BCS	VOSOJ
VOSOH	LDA	IOOPT
	BNE	VOSOK
VOSOJ	LDY	#3
	LDA	(ZF3),Y
	LDY	#1
	SBC	(ZF3),Y
	TAX
	LDY	#4
	LDA	(ZF3),Y
	LDY	#2
	SBC	(ZF3),Y
	TAY
	CLC
	TXA
	ADC	VZC3
	STA	SAVEND
	TYA
	ADC	VZC3+1
	STA	SAVEND+1
	LDA	VZC3
	STA	SAVBGN
	LDA	VZC3+1
	STA	SAVBGN+1
	JSR	AF422
	JSR	VAF8C9
	DB	$24
VOSNW	CLC
	LDX	SAVEND
	LDY	SAVEND+1
VOSNZ	RTS
;.PAGE 'SUBROUTINES'
;
;	TEST FOR DIRECT STATEMENT
;
AF3FF	LDA	DRCTSW
	BPL	RTSW
;
;	Display 'SEARCHING '
;
	LDY	#SERCHK-ERMSGS
	JSR	DSPERR
	LDA	FNSIZE
	BEQ	RTSW
;
;	Display 'FOR '
;
	LDY	#FORK-ERMSGS
	JSR	DSPERR
AF411	LDY	FNSIZE
	BEQ	RTSW
;
;	Display file name
;
	LDY	#0
PAR	LDA	(FNADDR),Y
	JSR	OUTCH
	INY
	CPY	FNSIZE
	BNE	PAR
RTSW	RTS
;
;	Point at 'LOADING'
;
AF422	LDY	#LOADK-ERMSGS
	LDA	OSLVSW
	BEQ	PAS
;
;	Point at 'SAVING '
;
	LDY	#VERK-ERMSGS
PAS	JMP	VAF1E2
;.PAGE 'SAVE PROGRAM FILE LOGIC'
;
;
;
SAVE	STX	SAVEND
	STY	SAVEND+1
	TAX
	LDA	ZPSTRT,X
	STA	SAVBGN
	LDA	ZPSTRT+1,X
	STA	SAVBGN+1
	JMP	(SAVVEC)
;
;
;
DOSAVE	LDA	DVCNUM
	BNE	ZV
ZU	JMP	VAF796
ZV	CMP	#SCREEN
	BEQ	ZU
	BCC	ZY
	LDA	#$61
	STA	IOOPT
	LDY	FNSIZE
	BNE	NRZV
	JMP	VAF793
NRZV	JSR	AF462
	JSR	VAF728
	LDA	DVCNUM
	JSR	AF0BA
	LDA	IOOPT
	JSR	AF12C
	LDY	#0
	JSR	AFBDC
	LDA	SCMPTR
	JSR	AF167
	LDA	SCMPTR+1
	JSR	AF167
VOSOW	JSR	AFD90
	BCS	ZX
	LDA	(SCMPTR),Y
	JSR	AF167
	JSR	CKSTOP
	BNE	VOSOV
VAF6CB	JSR	AF6E6
	LDA	#0
	SEC
	RTS
VOSOV	JSR	VAFD1B
	BNE	VOSOW
ZX	JSR	AF17E
AF6E6	BIT	IOOPT
	BMI	RTSZ
	LDA	DVCNUM
	JSR	AF0BA
	LDA	IOOPT
	AND	#$EF
	ORA	#$E0
	JSR	AF12C
	JSR	AF17E
RTSZ	CLC
	RTS
ZY	CMP	#$02
	BNE	VOSOY
	JMP	JE9
VOSOY	JSR	AF667
	BCC	ZU
	JSR	AF871
	BCS	VOSPA
	JSR	VAF728
	LDX	#SCREEN
	LDA	IOOPT
	AND	#$01
	BNE	VOSPB
	LDX	#$01
VOSPB	TXA
	JSR	AF5ED
	BCS	VOSPA
	JSR	AF8BC
	BCS	VOSPA
	LDA	IOOPT
	AND	#$02
	BEQ	VOSPE
	LDA	#$05
	JSR	AF5ED
	DB	$24
VOSPE	CLC
VOSPA	RTS
;
;
;
VAF728	LDA	DRCTSW
	BPL	VOSPA
;
;	Display "SAVING "
;
	LDY	#SAVEK-ERMSGS
	JSR	DSPERR
;
;
;
	JMP	AF411
;.PAGE 'Clock support'
;
;
;
UCLOCK	LDX	#$00
	INC	TIMER+2
	BNE	VOSPG
	INC	TIMER+1
	BNE	VOSPG
	INC	TIMER
VOSPG	SEC
	LDA	TIMER+2
	SBC	#$01
	LDA	TIMER+1
	SBC	#$1A
	LDA	TIMER
	SBC	#$4F
	BCC	YG
	STX	TIMER
	STX	TIMER+1
	STX	TIMER+2
YG	LDA	A912F
	CMP	A912F
	BNE	YG
	STA	A0209
	RTS
;
;	READ CLOCK
;
RCLOCK	SEI
	LDA	TIMER+2
	LDX	TIMER+1
	LDY	TIMER
;
;	SET CLOCK
;
SCLOCK	SEI
	STA	TIMER+2
	STX	TIMER+1
	STY	TIMER
	CLI
	RTS
;.PAGE 'SUBROUTINES'
;
;	CHECK FOR STOP KEY
;
AF32A	LDA	A0209
	CMP	#$FE
	BNE	RTSY
	PHP
	JSR	RESTIO
	STA	KEYCNT
	PLP
RTSY	RTS
;
;
;
VAF77E	LDA	#1
	DB	$2C
VAF781	LDA	#2
	DB	$2C
VAF784	LDA	#3
	DB	$2C
VAF787	LDA	#4
	DB	$2C
VAF78A	LDA	#5
	DB	$2C
VAF78D	LDA	#6
	DB	$2C
VAF790	LDA	#7
	DB	$2C
VAF793	LDA	#8
	DB	$2C
VAF796	LDA	#9
	PHA
;
;
;
	JSR	RESTIO
;
;
;
	LDY	#ERRORK-ERMSGS
	BIT	DRCTSW
	BVC	VOSPL
	JSR	DSPERR
	PLA
	PHA
	ORA	#$30
	JSR	OUTCH
VOSPL	PLA
	SEC
	RTS
;.PAGE
;
;
;
AF5AE	LDA	OSLVSW
	PHA
	JSR	AF87F
	PLA
	STA	OSLVSW
	BCS	PDG
	LDY	#0
	LDA	(ZF3),Y
	CMP	#$05
	BEQ	PDG
	CMP	#$01
	BEQ	PDD
	CMP	#SCREEN
	BEQ	PDD
	CMP	#$04
	BNE	AF5AE
PDD	TAX
	BIT	DRCTSW
	BPL	VOSPR
;
;	Display 'FOUND'
;
	LDY	#FOUNDK-ERMSGS
	JSR	DSPERR
;
;
;
	LDY	#5
PDE	LDA	(ZF3),Y
	JSR	OUTCH
	INY
	CPY	#21
	BNE	PDE
VOSPR	CLC
	DEY
PDG	RTS
;.PAGE
;
;
;
AF5ED	STA	ZE9
	JSR	AF667
	BCC	VOSPT
	LDA	SAVBGN+1
	PHA
	LDA	SAVBGN
	PHA
	LDA	SAVEND+1
	PHA
	LDA	SAVEND
	PHA
	LDY	#191
	LDA	#SPACE
PDH	STA	(ZF3),Y
	DEY
	BNE	PDH
	LDA	ZE9
	STA	(ZF3),Y
	INY
	LDA	SAVBGN
	STA	(ZF3),Y
	INY
	LDA	SAVBGN+1
	STA	(ZF3),Y
	INY
	LDA	SAVEND
	STA	(ZF3),Y
	INY
	LDA	SAVEND+1
	STA	(ZF3),Y
	INY
	STY	A0268
	LDY	#$00
	STY	ZE9
PDJ	LDY	ZE9
	CPY	FNSIZE
	BEQ	PDK
	LDA	(FNADDR),Y
	LDY	A0268
	STA	(ZF3),Y
	INC	ZE9
	INC	A0268
	BNE	PDJ
PDK	JSR	AF67D
	LDA	#$69
	STA	A0279
	JSR	AF8C4
	TAY
	PLA
	STA	SAVEND
	PLA
	STA	SAVEND+1
	PLA
	STA	SAVBGN
	PLA
	STA	SAVBGN+1
	TYA
VOSPT	RTS
;
;
;
AF667	LDX	ZF3
	LDY	ZF3+1
	CPY	#$02
	RTS
;
;
;
AF67D	JSR	AF667
	TXA
	STA	SAVBGN
	CLC
	ADC	#192
	STA	SAVEND
	TYA
	STA	SAVBGN+1
	ADC	#0
	STA	SAVEND+1
	RTS
;
;
;
AF495	JSR	AF5AE
	BCS	PAX
	LDY	#$05
	STY	A0268
	LDY	#0
	STY	ZE9
NRAW	CPY	FNSIZE
	BEQ	PAW
	LDA	(FNADDR),Y
	LDY	A0268
	CMP	(ZF3),Y
	BNE	AF495
	INC	ZE9
	INC	A0268
	LDY	ZE9
	BNE	NRAW
PAW	CLC
PAX	RTS
;
;
;
AF82D	JSR	AF667
	INC	A0270
	LDY	A0270
	CPY	#192
	RTS
;
;
;
AF83B	JSR	AF85E
	BEQ	PDZ
;
;	Display "PRESS PLAY ON TAPE"
;
	LDY	#PPLAYK-ERMSGS
VOSQF	JSR	DSPERR
;
;
;
VOSQC	JSR	AF91E
	JSR	AF85E
	BNE	VOSQC
;
;	Display "OK"
;
	LDY	#OKK-ERMSGS
;
;
;
	JMP	DSPERR
;
;
;
AF85E	LDA	#$40
	BIT	A911F
	BNE	PDZ
	BIT	A911F
PDZ	CLC
	RTS
;
;
;
AF871	JSR	AF85E
	BEQ	PDZ
;
;	Point at "PRESS RECORD & PLAY ON TAPE"
;
	LDY	#PRECK-ERMSGS
;
;	Unconditional branch
;
	BNE	VOSQF
;
;
;
AF87F	LDA	#0
	STA	STATUS
	STA	OSLVSW
	JSR	AF67D
VAF8C9	JSR	AF83B
	BCS	VOSQG
	SEI
	LDA	#$00
	STA	A0278
	STA	ZEB
	STA	ZE7
	STA	ZE9
	STA	A0268
	STA	A0266
	LDA	#$82
	LDX	#$0E
	BNE	NREC
AF8B9	JSR	AF67D
AF8BC	LDA	#$14
	STA	A0279
AF8C4	JSR	AF871
VOSQG	BCS	VOSQI
	SEI
	LDA	#$A0
	LDX	#$08
NREC	LDY	#$7F
	STY	A912E
	STA	A912E
	JSR	VAF160
	LDA	IRQVEC
	STA	V029F
	LDA	IRQVEC+1
	STA	V029F+1
	JSR	AFD1B
	LDA	#$02
	STA	ZFD
	JSR	AFBEC
	LDA	A911C
	AND	#$FD
	ORA	#$0C
	STA	A911C
	STA	A0207
	LDX	#$FF
NRED	LDY	#$FF
NREE	DEY
	BNE	NREE
	DEX
	BNE	NRED
	STA	A9129
	CLI
VOSQM	LDA	V029F+1
	CMP	IRQVEC+1
	CLC
	BEQ	VOSQI
	JSR	AF91E
	LDA	A912D
	AND	#$40
	BEQ	VOSQM
	LDA	A9114
	JSR	UCLOCK
	JMP	VOSQM
;
;
;
AF91E	JSR	CKSTOP
	CLC
	BNE	VOSQN
	JSR	AFCFB
	SEC
	PLA
	PLA
VOSQI	LDA	#$00
	STA	V029F+1
VOSQN	RTS
;
;
;
AF92E	STX	ZE8
	LDA	ZE7
	ASL	A
	ASL	A
	CLC
	ADC	ZE7
	CLC
	ADC	ZE8
	STA	ZE8
	LDA	#$00
	BIT	ZE7
	BMI	PJA
	ROL	A
PJA	ASL	ZE8
	ROL	A
	ASL	ZE8
	ROL	A
	TAX
PJB	LDA	A9128
	CMP	#$15
	BCC	PJB
	ADC	ZE8
	STA	A9124
	TXA
	ADC	A9129
	STA	A9125
	CLI
	RTS
;
;
;
AF95F	LDX	A9129
	LDY	#$FF
	TYA
	SBC	A9128
	CPX	A9129
	BNE	AF95F
	STX	ZE8
	TAX
	STY	A9128
	STY	A9129
	TYA
	SBC	ZE8
	STX	ZE8
	LSR	A
	ROR	ZE8
	LSR	A
	ROR	ZE8
	LDA	ZE7
	CLC
	ADC	#$3C
	BIT	A9121
	CMP	ZE8
	BCS	PJD
	LDX	A0266
	BEQ	PJE
	JMP	PJF
PJE	LDX	A026C
	BMI	PJG
	LDX	#$00
	ADC	#$30
	ADC	ZE7
	CMP	ZE8
	BCS	PJH
	INX
	ADC	#$26
	ADC	ZE7
	CMP	ZE8
	BCS	PJI
	ADC	#$2C
	ADC	ZE7
	CMP	ZE8
	BCC	PJU
PJG	JMP	PJK
PJU	LDA	ZEB
	BEQ	PJD
	STA	A0274
	BNE	PJD
PJH	INC	A0275
	BCS	PJN
PJI	DEC	A0275
PJN	SEC
	SBC	#$13
	SBC	ZE8
	ADC	A020A
	STA	A020A
	LDA	A026D
	EOR	#$01
	STA	A026D
	BEQ	PJO
	STX	HOLDCH
PJD	LDA	ZEB
	BEQ	PJP
	BIT	A912D
	BVC	PJP
	LDA	#0
	STA	A026D
	LDA	A026C
	BPL	PJR
	BMI	PJG
PKD	LDX	#$A6
	JSR	AF92E
	LDA	A0265
	BNE	PJU
PJP	JMP	ENDIRQ
PJO	LDA	A020A
	BEQ	PJV
	BMI	PJW
	DEC	ZE7
	DB	$2C
PJW	INC	ZE7
PJV	LDA	#0
	STA	A020A
	CPX	HOLDCH
	BNE	PJR
	TXA
	BNE	PJU
	LDA	A0275
	BMI	PJD
	CMP	#$10
	BCC	PJD
	STA	A0228
	BCS	PJD
PJR	TXA
	EOR	A0265
	STA	A0265
	LDA	ZEB
	BEQ	PJP
	DEC	A026C
	BMI	PKD
	LSR	HOLDCH
	ROR	ZFE
	LDX	#$DA
	JSR	AF92E
	JMP	ENDIRQ
PJK	LDA	A0228
	BEQ	PKF
	LDA	ZEB
	BEQ	PFG
PKF	LDA	A026C
	BPL	PJI
PFG	LSR	ZE8
	LDA	#$93
	SEC
	SBC	ZE8
	ADC	ZE7
	ASL	A
	TAX
	JSR	AF92E
	INC	A0266
	LDA	ZEB
	BNE	PKK
	LDA	A0228
	BEQ	PKL
	STA	A0274
	LDA	#0
	STA	A0228
	LDA	#$C0
	STA	A912E
	STA	ZEB
PKK	LDA	A0228
	STA	VZB5
	BEQ	PKM
	LDA	#0
	STA	ZEB
	LDA	#$40
	STA	A912E
PKM	LDA	ZFE
	STA	ZFC
	LDA	A0274
	ORA	A0275
	STA	VZB6
PKL	JMP	ENDIRQ
PJF	JSR	AFBEC
	STA	A0266
	LDX	#$DA
	JSR	AF92E
	LDA	ZFD
	BEQ	PKP
	STA	A0273
PKP	LDA	#$0F
	BIT	A0278
	BPL	PKQ
	LDA	VZB5
	BNE	PKR
	LDX	ZFD
	DEX
	BNE	PKS
	LDA	#$08
	JSR	AFBE5
	BNE	PKS
PKR	LDA	#$00
	STA	A0278
PKS	JMP	ENDIRQ
PKQ	BVS	PKV
	BNE	PKW
	LDA	VZB5
	BNE	PKS
	LDA	VZB6
	BNE	PKS
	LDA	A0273
	LSR	A
	LDA	ZFC
	BMI	PKZ
	BCC	PLA
	CLC
PKZ	BCS	PLA
	AND	#$0F
	STA	A0278
PKW	DEC	A0278
	BNE	PKS
	LDA	#$40
	STA	A0278
	JSR	AFBDC
	LDA	#0
	STA	A0279
	BEQ	PKS
PLA	LDA	#$80
	STA	A0278
	BNE	PKS
PKV	LDA	VZB5
	BEQ	PLG
	LDA	#$04
	JSR	AFBE5
	LDA	#0
	JMP	PLI
PLG	JSR	AFD90
	BCC	PLJ
	JMP	PLK
PLJ	LDX	A0273
	DEX
	BEQ	PLL
	LDA	OSLVSW
	BEQ	PLM
	LDY	#0
	LDA	ZFC
	CMP	(SCMPTR),Y
	BEQ	PLM
	LDA	#$01
	STA	VZB6
PLM	LDA	VZB6
	BEQ	PLO
	LDX	#$3D
	CPX	ZE9
	BCC	PLP
	LDX	ZE9
	LDA	SCMPTR+1
	STA	BSTACK+1,X
	LDA	SCMPTR
	STA	BSTACK,X
	INX
	INX
	STX	ZE9
	JMP	PLO
PLL	LDX	A0268
	CPX	ZE9
	BEQ	PLR
	LDA	SCMPTR
	CMP	BSTACK,X
	BNE	PLR
	LDA	SCMPTR+1
	CMP	BSTACK+1,X
	BNE	PLR
	INC	A0268
	INC	A0268
	LDA	OSLVSW
	BEQ	PLU
	LDA	ZFC
	LDY	#0
	CMP	(SCMPTR),Y
	BEQ	PLR
	INY
	STY	VZB6
PLU	LDA	VZB6
	BEQ	PLO
PLP	LDA	#$10
	JSR	AFBE5
	BNE	PLR
PLO	LDA	OSLVSW
	BNE	PLR
	TAY
	LDA	ZFC
	STA	(SCMPTR),Y
PLR	JSR	VAFD1B
	BNE	PMA
PLK	LDA	#$80
PLI	STA	A0278
	LDX	ZFD
	DEX
	BMI	PMC
	STX	ZFD
PMC	DEC	A0273
	BEQ	PMD
	LDA	ZE9
	BNE	PMA
	STA	ZFD
	BEQ	PMA
PMD	JSR	AFCFB
	JSR	AFBDC
	LDY	#0
	STY	A0279
VOSTE	LDA	(SCMPTR),Y
	EOR	A0279
	STA	A0279
	JSR	VAFD1B
	JSR	AFD90
	BCC	VOSTE
	LDA	A0279
	EOR	ZFC
	BEQ	PMA
	LDA	#$20
	JSR	AFBE5
PMA	JMP	ENDIRQ
;.PAGE
;
;
;
AFBDC	LDA	SAVBGN+1
	STA	SCMPTR+1
	LDA	SAVBGN
	STA	SCMPTR
	RTS
;
;
;
AFBEC	LDA	#8
	STA	A026C
	LDA	#0
	STA	A026D
VAFBE5	STA	A0274
	STA	A0265
	STA	A0275
	RTS
;
;
;
AFC00	LDA	ZFC
	LSR	A
	LDA	#$60
	BCC	AFC09
AFC07	LDA	#$B0
AFC09	LDX	#0
AFC0B	STA	A9128
	STX	A9129
	LDA	A9120
	EOR	#$08
	STA	A9120
	AND	#$08
	RTS
;.PAGE
PHE	SEC
	ROR	SCMPTR+1
	BMI	PHH
AFC21	LDA	A0274
	BNE	PHF
	LDA	#$10
	LDX	#$01
	JSR	AFC0B
	BNE	PHH
	INC	A0274
	LDA	SCMPTR+1
	BPL	PHH
	JMP	AFCBB
PHF	LDA	A0275
	BNE	PHG
	JSR	AFC07
	BNE	PHH
	INC	A0275
	BNE	PHH
PHG	JSR	AFC00
	BNE	PHH
	LDA	A026D
	EOR	#$01
	STA	A026D
	BEQ	PHJ
	LDA	ZFC
	EOR	#$01
	STA	ZFC
	AND	#$01
	EOR	A0265
	STA	A0265
PHH	JMP	ENDIRQ
PHJ	LSR	ZFC
	DEC	A026C
	LDA	A026C
	BEQ	PHN
	BPL	PHH
AFC74	JSR	AFBEC
	CLI
	LDA	A026F
	BEQ	PHL
	LDX	#0
	STX	HOLDCH
	DEC	A026F
	LDX	ZFD
	CPX	#$02
	BNE	PHK
	ORA	#$80
PHK	STA	ZFC
	BNE	PHH
PHL	JSR	AFD90
	BCC	VOSTV
	BNE	PHE
	INC	SCMPTR+1
	LDA	HOLDCH
	STA	ZFC
	BCS	PHH
VOSTV	LDY	#0
	LDA	(SCMPTR),Y
	STA	ZFC
	EOR	HOLDCH
	STA	HOLDCH
	JSR	VAFD1B
	BNE	PHH
PHN	LDA	A0265
	EOR	#$01
	STA	ZFC
JMP	JMP	ENDIRQ
;.PAGE
;
;
;
AFCBB	DEC	ZFD
	BNE	PEW
	JSR	AFFED
PEW	LDA	#$50
	STA	A0273
	LDX	#$08
	SEI
	JSR	AFD1B
	BNE	JMP
AFCCF	LDA	#$78
	JSR	AFC09
	BNE	JMP
	DEC	A0273
	BNE	JMP
	JSR	AFBEC
	DEC	A0279
	BPL	JMP
	LDX	#$0A
	JSR	AFD1B
	CLI
	INC	A0279
	LDA	ZFD
	BEQ	VOSUE
	JSR	AFBDC
	LDX	#$09
	STX	A026F
	BNE	AFC74
;
;
;
AFCFB	PHP
	SEI
	JSR	AFFED
	LDA	#$7F
	STA	A912E
	LDA	#$F7
	STA	A9120
	LDA	#$40
	STA	A912B
	JSR	VAFE39
	LDA	V029F+1
	BEQ	VOSUG
	STA	IRQVEC+1
	LDA	V029F
	STA	IRQVEC
VOSUG	PLP
	RTS
;.PAGE
;
;
;
VOSUE	JSR	AFCFB
	BEQ	JMP
AFD1B	LDA	IRQTBL-8,X
	STA	IRQVEC
	LDA	IRQTBL-7,X
	STA	IRQVEC+1
	RTS
;
;
;
AFFED	LDA	A911C
	ORA	#$0E
	STA	A911C
	RTS
;
;
;
AFD90	SEC
	LDA	SCMPTR
	SBC	SAVEND
	LDA	SCMPTR+1
	SBC	SAVEND+1
	RTS
;
;
;
VAFD1B	INC	SCMPTR
	BNE	VOSUI
	INC	SCMPTR+1
VOSUI	RTS
;.PAGE 'SYSTEM RESTART'
;
;
;
AFD38	LDX	#$FF
	SEI
	TXS
	CLD
	JSR	VAFD3F
	BNE	VOSUJ
	JMP	(AA000)
VOSUJ	JSR	VAFD8D
	JSR	VAFD52
	JSR	VAFDF9
	JSR	AE1E1
	CLI
	JMP	(BCSVEC)
;
;
;
VAFD3F	LDX	#$05
VOSUL	LDA	VAFD4D-1,X
	CMP	AA000+3,X
	BNE	VOSUK
	DEX
	BNE	VOSUL
VOSUK	RTS
;
;
;
VAFD4D	DB	$41,$30,$C3,$C2,$CD
;
;
;
VAFD52	LDX	#>VAFD6D
	LDY	#<VAFD6D
	CLC
VAFD57	STX	VZC3
	STY	VZC3+1
	LDY	#31
VOSUN	LDA	IRQVEC,Y
	BCS	VOSUM
	LDA	(VZC3),Y
VOSUM	STA	(VZC3),Y
	STA	IRQVEC,Y
	DEY
	BPL	VOSUN
	RTS
;
;
;
VAFD6D	DW	INTSVC
	DW	DOBRK
	DW	DONMI
	DW	OPEN
	DW	CLOSE
	DW	SIDV
	DW	SODV
	DW	AF27D
	DW	ICH
	DW	OCH
	DW	AF32A
	DW	GCH
	DW	NRF26E
	DW	DOBRK
	DW	DOLOAD
	DW	DOSAVE
;
;
;
VAFD8D	LDA	#0
	TAX
VOSUP	STA	ZPSTRT,X
	STA	CONBUF,X
	STA	BAEVEC,X
	INX
	BNE	VOSUP
	LDX	#>CSBUF1
	LDY	#<CSBUF1
	STX	ZF3
	STY	ZF3+1
	STA	SAVBGN
	STA	A0261
	STA	LOMPTR
	TAY
	LDA	#$04
	STA	SAVBGN+1
VOSUS	INC	SAVBGN
	BNE	VOSUQ
	INC	SAVBGN+1
VOSUQ	JSR	VALRAM
	LDA	A0261
	BEQ	VOSUR
	BCS	VOSUS
	LDY	SAVBGN+1
	LDX	SAVBGN
	CPY	#$20
	BCC	VOSUT
	CPY	#$21
	BCS	VOSUU
	LDY	#$1E
	STY	SCRMPG
VOSUV	JMP	VAFE7B
VOSUU	LDA	#$12
	STA	LOMPTR+1
	LDA	#$10
	STA	SCRMPG
	BNE	VOSUV
VOSUR	BCC	VOSUS
	LDA	SAVBGN+1
	STA	LOMPTR+1
	STA	A0261
	CMP	#$11
	BCC	VOSUS
VOSUT	JSR	VAE5C3
	JMP	VOSUT
;
;
;
IRQTBL	DW	AFCCF
	DW	AFC21
	DW	INTSVC
	DW	AF95F
;
;
;
VAFDF9	LDA	#$7F
	STA	A911E
	STA	A912E
	LDA	#$40
	STA	A912B
	LDA	#$40
	STA	A911B
	LDA	#$FE
	STA	A911C
	LDA	#$DE
	STA	A912C
	LDX	#$00
	STX	A9112
	LDX	#$FF
	STX	A9122
	LDX	#$00
	STX	A9123
	LDX	#$80
	STX	A9113
	LDX	#$00
	STX	A911F
	JSR	VAEF84
	LDA	#$82
	STA	A911E
	JSR	VAEF8D
VAFE39	LDA	#$C0
	STA	A912E
	LDA	#$89
	STA	A9124
	LDA	#$42
	STA	A9125
	RTS
;.PAGE 'VECTORED ROUTINES'
;
;	SET FILE NAME
;
SETFNM	STA	FNSIZE
	STX	FNADDR
	STY	FNADDR+1
	RTS
;
;	SET I/O PARAMETERS
;
SETIOP	STA	FILNUM
	STX	DVCNUM
	STY	IOOPT
	RTS
;
;	READ I/O STATUS
;
RDSTAT	LDA	DVCNUM
	CMP	#$02
	BNE	VOSUY
	LDA	V0297
	LDA	#$00
	STA	V0297
	RTS
;
;	CONTROL MESSAGE DISPLAY
;
SETMSG	STA	DRCTSW
VOSUY	LDA	STATUS
AFBE5	ORA	STATUS
	STA	STATUS
	RTS
;
;	SET SERIAL TIME OUT
;
SETSTO	STA	V0285
	RTS
;
;	READ/SET HIGH MEMORY
;
RSHMEM	BCC	VAFE7B
VAFE75	LDX	HIMPTR
	LDY	HIMPTR+1
VAFE7B	STX	HIMPTR
	STY	HIMPTR+1
	RTS
;
;	READ/SET LOW MEMORY
;
RSLMEM	BCC	VOSVA
	LDX	LOMPTR
	LDY	LOMPTR+1
VOSVA	STX	LOMPTR
	STY	LOMPTR+1
	RTS
;
;
;
VALRAM	LDA	(SAVBGN),Y
	TAX
	LDA	#$55
	STA	(SAVBGN),Y
	CMP	(SAVBGN),Y
	BNE	LDACLC+1
	ROR	A
	STA	(SAVBGN),Y
	CMP	(SAVBGN),Y
	BNE	LDACLC+1
LDACLC	LDA	#$18
	TXA
	STA	(SAVBGN),Y
	RTS
;.PAGE 'INTERRUPT LOGIC'
;
;	NON-MASKABLE INTERRUPT
;
NMI	SEI
	JMP	(NMIVEC)
;
;
;
DONMI	PHA
	TXA
	PHA
	TYA
	PHA
	LDA	A911D
	BPL	VOSVD
	AND	A911E
	TAX
	AND	#$02
	BEQ	VOSVE
	JSR	VAFD3F
	BNE	VOSVF
	JMP	(AA000+2)
VOSVF	BIT	A9111
	JSR	UCLOCK
	JSR	CKSTOP
	BNE	VOSVD
;
;
;
DOBRK	JSR	VAFD52
	JSR	VAFDF9
	JSR	AE1E1
	JMP	(BWSVEC)
;
;
;
VOSVE	LDA	A911E
	ORA	#$80
	PHA
	LDA	#$7F
	STA	A911E
	TXA
	AND	#$40
	BEQ	VOSVH
	LDA	#$CE
	ORA	VZB5
	STA	A911C
	LDA	A9114
	PLA
	STA	A911E
	JSR	VAEFA3
VOSVD	JMP	ENDIRQ
VOSVH	TXA
	AND	#$20
	BEQ	VOSVI
	LDA	A9110
	AND	#$01
	STA	A0273
	LDA	A9118
	SBC	#$16
	ADC	V0299
	STA	A9118
	LDA	A9119
	ADC	V0299+1
	STA	A9119
	PLA
	STA	A911E
	JSR	VAF036
	JMP	ENDIRQ
VOSVI	TXA
	AND	#$10
	BEQ	ENDIRQ
	LDA	V0293
	AND	#$0F
	BNE	VOSVK
VOSVK	ASL	A
	TAX
	LDA	VAFF5C-2,X
	STA	A9118
	LDA	VAFF5C-1,X
	STA	A9119
	LDA	A9110
	PLA
	ORA	#$20
	AND	#$EF
	STA	A911E
	LDX	V0298
	STX	A0274
ENDIRQ	PLA
	TAY
	PLA
	TAX
	PLA
	RTI
;
;
;
VAFF5C	DB	$92,$27,$40,$1A,$C6,$11
	DB	$74,$0E,$EE,$0C,$45,$06
	DB	$F1,$02,$46,$01,$B8,$00
	DB	$71,$00,$2A,$00
;.PAGE 'INTERRUPT/BREAK HANDLER'
;
;	SAVE REGISTERS
;
AE66B	PHA
	TXA
	PHA
	TYA
	PHA
	TSX
;
;	TEST INTERRUPT TYPE
;
	LDA	BSTACK+4,X
	AND	#$10
	BEQ	YV
	JMP	(BRKVEC)
YV	JMP	(IRQVEC)
;
;
;
	DB	$FF,$FF,$FF,$FF,$FF
;.PAGE 'BRANCH TABLE'
	JMP	VAFD52
	JMP	VAFD57
SMSGE	JMP	SETMSG
	JMP	AF12C
	JMP	AF15B
HIMEME	JMP	RSHMEM
LOMEME	JMP	RSLMEM
SCKBE	JMP	SCANKB
SSERTE	JMP	SETSTO
	JMP	AF187
	JMP	AF167
	JMP	VAEEF6
	JMP	AF17E
	JMP	AF0BA
	JMP	AF0B6
RSTATE	JMP	RDSTAT
SIOPE	JMP	SETIOP
SFNAME	JMP	SETFNM
VOPEN	JMP	(OPNVEC)
VCLOSE	JMP	(CLOVEC)
SETIPD	JMP	(SIDVEC)
SETOPD	JMP	(SODVEC)
RESTIO	JMP	(RDVVEC)
INPCH	JMP	(ICHVEC)
OUTCH	JMP	(OCHVEC)
VLOAD	JMP	LOAD
VSAVE	JMP	SAVE
SCLKE	JMP	SCLOCK
RCLKE	JMP	RCLOCK
CKSTOP	JMP	(CSTVEC)
GETCH	JMP	(GCHVEC)
ABRTIO	JMP	(HIOVEC)
UPDCLK	JMP	UCLOCK
RSPRME	JMP	RDSPRM
PLOTE	JMP	PLOT
RADIOE	JMP	RDIOAD
	DB	$FF,$FF,$FF,$FF
;.PAGE 'VECTORS'
	DW	NMI
	DW	AFD38
	DW	AE66B
;.PAGE 'THE END'
*	.END
